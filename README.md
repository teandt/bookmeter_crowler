# なにをするツール？
読書メーターの「読んだ本」「積読本」のリストをクロールして取得するツールです。

過去に似たようなツールを作っている人もいましたが古そうだったので作り直してみました。  
取得したデータをブクログ形式のCSVに出力出来るため、ブクログへの移行に使用出来ます。  
読んだ日付、本のタイトル、著者名が取得でき、必要に応じて書籍詳細をクロールして本のタイトルの正式版、ページ数、ASINコードを取得してSQLiteで保存します。

# 機能
-rd: 「読んだ本」のリストをクロールして取得  
-st: 「積読本」のリストをクロールして取得  
-dt: 取得した「読んだ本」または「積読本」のリストにある本で、書籍詳細が取得されていない場合に取得  
-csv: 「読んだ本」「積読本」のリストをもとにブクログ形式のCSVファイルを出力します。-dtですべての詳細データを取得している必要があります。  

scrapyのSpider確認用にJSONファイル出力は残しています。  
今のところレビュー記録や本棚登録状態を取得出来るようにするかは検討中。javascript対応が必要なので余裕があれば対応予定。（devブランチ側で試し中）

# pipでインストールが必要なパッケージ
- scrapy
- python-dotenv
- SQLAlchemy
- scrapy-splash
  
pip freezeしているので  
```
pip install -r requirements
```
でインストールしてください。  
依存関係で色々インストールされるためvenvを推奨します。  
```
python3 -m venv venv
source venv/bin/activate
pip install -r requirements
```

# 設定
読書メーターのユーザーIDを指定しておく必要があるので、cd_bookmeter/env/.env にUSER_ID="0000"を自分のユーザIDに変更して実行します。  
.env.exampleファイルを参考に作成してください。

splash実行のために事前にdocker-compose.ymlを編集して環境を設定しておく。
必要があればポート番号はcr_bookmeter/settings.pyの
```
SPLASH_URL = 'http://localhost:8050'
```
をメンテナンス。

# 実行方法
```
source venv/bin/activate
cd cr_bookmeter
docker compose up -d
python3 bookmeter_crawl.py [オプション]
```
オプションはヘルプを見てください。一部DBの確認用にオプションを残しています。
```
  -h, --help            show this help message and exit
  -st, --stacked        積読本リスト取得
  -rd, --read           読んだ本リスト取得
  -dt, --detail         書籍詳細の取得
  -ckst, --checkstacked
                        DBのデータ確認（積読本）
  -ckrd, --checkread    DBのデータ確認（読んだ本）
  -ckd, --checkdetail   DBのデータ確認（詳細）
  -deldt, --deletedetail
                        不要な書籍詳細データを削除
  -csv, --csv           CSV出力
```


# 処理の流れのイメージ
bookmeter_crawl.pyで実行、オプションによってどこをスクレイピングしに行くのかを指定。  
未読リストor読んだ本リストを取得してSQLiteに保存、更新  
書籍詳細オプションが付いている場合、各リストで詳細が取得されていない書籍の書籍ページをクロールして詳細を取得、SQLiteに保存更新  

書籍詳細のクローリングはアクセス数が多くなるため、読書メーターサイト側のアクセス制限に引っかかる可能性があります。  
一定期間503エラーが続くと思いますがリトライを多めに取っているので待ちましょう。  
最悪、リトライオーバーした場合も未取得のものを再取得しに行くので何度か試してください。

# データ
積読本／読んだ本リストでは以下の情報を取得します。
```
    num ： 取得順をオートインクリメントで主キーにしておく（どうやら読んだ本リストは同じ本を複数回表示するようなので）
    id : 読書メーターの書籍番号
    short_title ： タイトル（長い場合は後ろが切れる）
    author ： 著者リスト。複数の著者だった場合まとめて入るのが後で課題かも？
    date ：積読本リストでは基本的にNullが入る想定。読んだ本リストだと読書日が入る（不明、で登録すると「日付不明」が入るので要注意）
    url ：読書メーターの書籍詳細Url
```

# ブクログ形式のインポート用CSVファイルの出力
以下のフォーマットで出力します。
```
サービスID, アイテムID, 13桁ISBN, カテゴリ, 評価, 読書状況, レビュー, タグ, 読書メモ(非公開), 登録日時, 読了日
```
出力されるファイルはcsv/booklog.csvとなります。  
出力されるファイルの文字コードはS-JISです。UTF-8で出力すると正常に登録されません。

CSVファイル出力する場合、積読本、読んだ本のリストに対応する詳細データが揃っていることが条件で、事前にチェックを行います。

出力されたファイルをブクログのまとめて登録（CSV）から登録します  
https://booklog.jp/input/file

数千件以上になると一時的にエラーになるかもしれませんが時間がかかっているようです。  
もし数が多すぎてうまく登録出来ない場合はファイルを分けてください。  
行単位で扱われているので、どこの行で区切っても問題ありません。